<!--
To change this template, choose Tools | Templates
and open the template in the editor.
-->
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
  <head>
    <title></title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

    <script type="text/javascript" src="http://maps.google.com/maps/api/js?libraries=geometry&sensor=false">
    </script>
    <script type="text/javascript" src="http://code.google.com/apis/gears/gears_init.js">
    </script>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.min.js">
    </script>

    <script type="text/javascript" src="splitter.js"></script>
    <script type="text/javascript" src="geolib.js"></script>
    <script type="text/javascript" src="FreeServices.json"></script>

    <style type="text/css">
      body img { border-style: none }
      .datalist div { }
      .datalist ul { border: 0; margin: 0; padding: 0; }
      .datalist ul li { list-style-type: none }
      .datalist ul li a { border: 0; padding: 10px; text-decoration: none; display: block; overflow: hidden; }
      .datalist ul li a:hover { background-color: #DBF1F9;/* light blue */ }
      .itemPlain a { background-color: inherit}
      .itemSel a { background-color: #007F00}
      .contentInfo { float: none }
      /* Place Styles */
      .hiddenDist { visibility: hidden; display: none}
      .placeImg { float: left; border: 0px; }
      .placeDist {  float: right; font-style: italic; margin-right: 24px;}
      .placeName { float: left; font-weight: bold; }
      .placeAddress { float: none; clear: left; }
      .placePhone { font-size: larger; font-weight: bold}
      .placeDesc { font-size: larger}
      /* Splitter */
      .vsplitbar {
        width: 5px;
        background: #aaa;
      }
    </style>

    <script type="text/javascript">

      var SFBounds;
      var theInfoWin = null;
      var markersLoaded = false;
      var rootUL;

      var globalNumVisible = 0;
      var globalUserAddress = "";

      function init()
      {
        // Init SF Bounds
        var sw = new google.maps.LatLng(37.70567075998761, -122.51793249606325);
        var ne = new google.maps.LatLng(37.83051256186211, -122.361377320282);
        SFBounds = new google.maps.LatLngBounds(sw, ne);

        geolib.init(
        {mapDivName: 'map_canvas',
          formAddressName: 'address',
          formPosName: 'posLatlng',
          alwaysLookUpUserAddress: true,
          acceptPosChange: acceptPosChange,
          markerPosChanged: onMarkerPosChanged,
          markerAddrChanged: onMarkerAddrChanged,
          errorDivName: "addressError"});

        theInfoWin = new google.maps.InfoWindow();

        google.maps.event.addListener(geolib.getMap(), "bounds_changed", buildVisiblePlaceList);

        geolib.getMarker().setZIndex(1000);
        geolib.getMap().setZoom(12);
        
        geolib.getMarker().setIcon(imageUrls3D["MyLoc"]);
        
        //$("#myloc").html("<img src='" + imageUrls2D["MyLoc"] + "'/> My Address");

        loadAllMarkers();
      }

      function acceptPosChange(pos)
      {
        var acceptable = SFBounds.contains(pos);
        var statusText = (acceptable ? "" : "This is not a valid San Francisco address. Please try again");

        document.getElementById("addressError").innerHTML = statusText;
		
        return acceptable;
      }

      function onMarkerPosChanged(pos)
      {
        if (markersLoaded) {
          computeMarkerDist();
        }
        buildVisiblePlaceList();
      }

      function onMarkerAddrChanged(text)
      {
        globalUserAddress = text;
        updateInfoStatus();
      }
      
      function updateInfoStatus()
      {
        var infoStr = "<i>Showing " + globalNumVisible + " services nearest to farthest from ";
        infoStr += "<img src='" + imageUrls2D["MyLoc"] + "'/>";
        infoStr += "<b>\"" + globalUserAddress + "\"</b></i>";

        document.getElementById("statusAddr").innerHTML = infoStr;
      }

      var imageUrls2D =
        {"Pantry": "http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=P|0099FF",
        "Eats" : "http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=E|FF3300",
        "Shelter" : "http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=S|FFFF00",
        "MyLoc" : "http://chart.apis.google.com/chart?chst=d_map_pin_icon&chld=location|00FF00"};

      var imageUrls3D =
        {"Pantry": "http://chart.apis.google.com/chart?chst=d_map_pin_letter_withshadow&chld=P|0099FF",
        "Eats" : "http://chart.apis.google.com/chart?chst=d_map_pin_letter_withshadow&chld=E|FF3300",
        "Shelter" : "http://chart.apis.google.com/chart?chst=d_map_pin_letter_withshadow&chld=S|FFFF00",
        "MyLoc" : "http://chart.apis.google.com/chart?chst=d_map_pin_icon_withshadow&chld=location|00FF00"};

      function addFilterCheck(index, folder)
      {
        var root = document.getElementById("markerFilters");
        
        //root.appendChild(document.createElement("br"));

        var img = document.createElement("img");
        img.src = imageUrls2D[folder.name];
        root.appendChild(img);

        var input = document.createElement("input");
        input.type = "checkbox";
        input.name = "checkbox" + folder.name;
        input.id = input.name;
        input.onclick = function()
        {
          toggleFilterCheck(folder.name, this.checked);
        };
        
        root.appendChild(input);
        input.checked = "checked";
        
        var label = document.createElement("label");
        root.appendChild(label);
        label.setAttribute("for", input.id);
        label.appendChild(document.createTextNode("Show " + folder.name));
      }

      function round(value, decimal)
      {
        var scale = Math.pow(10, decimal);
        return Math.round(value * scale) / scale;
      }

      function computeMarkerDist()
      {
        var orig = geolib.getPos();
        
        for (i = 0; i < DATA.Markers.Folder.length; i++)
        {
          var folder = DATA.Markers.Folder[i];

          for (j = 0; j < folder.Placemark.length; j++)
          {
            var place = folder.Placemark[j];
            
            var pos = place.marker.getPosition();
            place.dist = google.maps.geometry.spherical.computeDistanceBetween(orig, pos);

            var feet = place.dist * 3.2808399;
            var units = "";
            //            if (feet < 1024) {
            //              place.distDesc = String(feet);
            //              units = " ft.";
            //            } else {
            place.distDesc = String(feet / 1024);
            units = " mi.";
            //            }
            place.distDesc = round(place.distDesc, 2);
            place.distDesc += units;
            place.distDesc += " Away";
          }
        }
      }


      function toggleFilterCheck(name, state)
      {
        theInfoWin.close();
        
        for (i = 0; i < DATA.Markers.Folder.length; i++)
        {
          var folder = DATA.Markers.Folder[i];

          if (folder.name == name) {
            for (j = 0; j < folder.Placemark.length; j++)
            {
              var place = folder.Placemark[j];
              place.marker.setVisible(state);
            }
          }
        }

        buildVisiblePlaceList();

      }

      function selectMarker(i, j, elem)
      {
        var marker = DATA.Markers.Folder[i].Placemark[j].marker;
        google.maps.event.trigger(marker, "click");
        geolib.getMap().setCenter(marker.getPosition());
      }

      function getAddressString(place)
      {
        var full = place.address;
        if (place.address != "")
          full += ", ";
        full += "<br/>";
        if (place.city != "") {
          full += place.city + ", " + place.state;
        }
        full += " " + place.zip;
        return full;
      }

      function getSpanString(spanClass, contents)
      {
        return "<span class='" + spanClass + "' + id='" + spanClass + "'>" + contents + "</span>";
      }

      function getPlaceHtml(place, i)
      {
        var descText = "";

        // Hidden Dist
        if (place.dist) {
          descText += getSpanString("hiddenDist", place.dist);
        }
        
        var imgStr = "<img src=\"" + imageUrls2D[DATA.Markers.Folder[i].name] + "\"/>";

        descText += "<div>";

        if (place.distDesc) {
          descText += getSpanString("placeDist", place.distDesc);
        }
        
        if (place.name) {
          descText += getSpanString("placeName", imgStr + place.name);
        }

        descText += "<br/>";
        descText += "</div>";
        descText += "<br/>";
        
        if (place.address) {
          descText += getSpanString("placeAddress", getAddressString(place));
          descText += "<br/>";
        }

        if (place.phone) {
          descText += getSpanString("placePhone", place.phone);
          descText += "<br/>";
        }

        if (place.description) {
          descText += getSpanString("placeDesc", "<p>" + place.description + "</p>");
        }
        
        return descText;
      }

      function createLI(place, i, j)
      {
        var newLI = document.createElement("li");
        //newLI.setAttribute("id", place.index);

        //    if (selectedMarker == place.marker) {
        //      newLI.setAttribute("class", "itemSel");
        //    }
        
        var onclickSelectMarker = "onclick=" + "\"selectMarker(";
        onclickSelectMarker += i + ", ";
        onclickSelectMarker += j + ", this)\"";
		
        var descText = getPlaceHtml(place, i, false);

        newLI.innerHTML = "<a " + onclickSelectMarker + "href='#'>" + descText + "</a>";
        //newLI.innerHTML = "<div " + onclickSelectMarker + ">" + descText + "</div>";

        place.theLI = newLI;
        
        if (place.dist == undefined) {
          rootUL.appendChild(newLI);
          return;
        }

        var newDist = place.dist;

        for (c = 0; c < rootUL.childNodes.length; c++)
        {
          var dist = Number($("//span[id='hiddenDist']", rootUL.childNodes[c]).text());

          if (newDist < dist) {
            rootUL.insertBefore(newLI, rootUL.childNodes[c]);
            return;
          }
        }

        rootUL.appendChild(newLI);
      }

      function buildVisiblePlaceList()
      {
        if (!markersLoaded) {
          return false;
        }
        
        var root = document.getElementById("data_list");

        if (root.childNodes.length > 0) {
          root.removeChild(root.childNodes[0]);
        }
        rootUL = document.createElement("ul");
        root.appendChild(rootUL);

        var bounds = geolib.getMap().getBounds();

        var count = 0;

        for (i = 0; i < DATA.Markers.Folder.length; i++)
        {
          var folder = DATA.Markers.Folder[i];

          if (!document.getElementById("checkbox" + folder.name).checked) {
            continue;
          }

          for (j = 0; j < folder.Placemark.length; j++)
          {

            var place = folder.Placemark[j];

            if (!place.marker.getVisible()) {
              continue;
            }

            if (!bounds.contains(place.marker.getPosition())) {
              continue;
            }

            count++;
            createLI(place, i, j);
          }
        }
		
        //document.getElementById("statusFound").innerHTML = "<b>Showing " + count + " Free Services on this map.</b>";
        globalNumVisible = count;
        updateInfoStatus();
      }

      //var allPlaces;

      function loadAllMarkers()
      {
        var map = geolib.getMap();

        //allPlaces = new Array();
        //var count = 0;

        for (i = 0; i < DATA.Markers.Folder.length; i++)
        {
          var folder = DATA.Markers.Folder[i];
          
          addFilterCheck(i, folder);

          for (j = 0; j < folder.Placemark.length; j++)
          {
            var place = folder.Placemark[j];
            
            place.marker = new google.maps.Marker(
            {
              map: map,
              position: geolib.parseLatLong(place.Point.coordinates, true),
              draggable: false,
              title: place.name + "\n" + getAddressString(place),
              icon: new google.maps.MarkerImage(imageUrls3D[folder.name])
            });

            //place.index = count++;
            //allPlaces.push(place);
            
            function doOpen(win, place, i)
            {
              return function()
              {
                var divWrap = "<div class='contentInfo'>" + getPlaceHtml(place, i, false) + "</div>";
                win.setContent(divWrap);
                win.open(map, place.marker);				
              }
            }

            google.maps.event.addListener(place.marker, "click", doOpen(theInfoWin, place, i));
          }
        }

        markersLoaded = true;
        computeMarkerDist();
      }
	  
      function showClicked()
      {
        if (!geolib.syncToEnteredAddress()) {
          geolib.getMap().setCenter(geolib.getPos());
        }
        geolib.getMap().setZoom(15);
      }

      $(document).ready(function()
      {
        $("#floatSplitter").splitter({
          minLeft: 100, sizeLeft: 500, minRight: 100,
          resizeToWidth: true
        });
        
        init();
      });

    </script>
  </head>
  <body>
    <h1>San Francisco Free Services Locator</h1>
    <div id="inputs">Enter your address:
      <input type="text" name="address" id="address" style="width: 500px" value="San Francisco, CA"/>
      <input type="hidden" name="posLatlng" id="posLatlng" value="37.7749295, -122.4194155"/>
      <br/>
      <input type="button" name="centerMe" id="centerMe" value="Show Services Near This Address" onclick="showClicked()"/>
      <input type="button" name="zoomIn" id="zoomIn" value="Zoom In" onclick="geolib.getMap().setZoom(geolib.getMap().getZoom() + 1)"/>
      <input type="button" name="zoomIn" id="zoomOut" value="Zoom Out" onclick="geolib.getMap().setZoom(geolib.getMap().getZoom() - 1)"/>
    </div>
    <div id="addressError" style="color: red"></div>
    <br/>
    <div id="statusFound"></div><div id="statusAddr"></div><br/>
    <div id="markerFilters"></div>
    <br/>

    <div id="floatSplitter" style="width: 100%; height: 100%">
      <div style="overflow: scroll">
      <div id="data_list" class="datalist"></div>
      </div>
      <div id="map_canvas" style="height: 100%"></div>
    </div>

  </body>
</html>
